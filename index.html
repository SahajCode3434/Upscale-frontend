<script>
  const imageUpload = document.getElementById("imageUpload");
  const previewImage = document.getElementById("previewImage");
  const resultImage = document.getElementById("resultImage");
  const submitBtn = document.getElementById("submitBtn");
  const loader = document.getElementById("loading");

  let uploadedImage = null;

  imageUpload.addEventListener("change", () => {
    const file = imageUpload.files[0];
    if (file) {
      uploadedImage = file;
      const reader = new FileReader();
      reader.onload = () => {
        previewImage.src = reader.result;
        resultImage.src = reader.result;
        resultImage.style.clipPath = "inset(0 50% 0 0)";
      };
      reader.readAsDataURL(file);
    }
  });

  submitBtn.addEventListener("click", async () => {
    if (!uploadedImage) {
      alert("Please upload an image first.");
      return;
    }

    loader.classList.remove("hidden");
    resultImage.src = "";

    const formData = new FormData();
    formData.append("image", uploadedImage);

    try {
      const response = await fetch("https://tree1.sahajsharma921.workers.dev", {
        method: "POST",
        body: formData,
      });
      const blob = await response.blob();
      resultImage.src = URL.createObjectURL(blob);

      animateReveal();
    } catch (err) {
      alert("Upscale failed. Try again later.");
      console.error(err);
    } finally {
      loader.classList.add("hidden");
    }
  });

  // === PixelCut-style preview animation ===
  function animateReveal() {
    let progress = 0;
    let direction = 1;
    const interval = setInterval(() => {
      progress += direction * 2;
      if (progress >= 100 || progress <= 0) direction *= -1;
      resultImage.style.clipPath = `inset(0 ${100 - progress}% 0 0)`;
    }, 25);

    setTimeout(() => clearInterval(interval), 2500);
  }
</script>
